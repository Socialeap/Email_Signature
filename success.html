<script>
document.addEventListener('DOMContentLoaded', () => {
    const loadingState = document.getElementById('loading-state');
    const successState = document.getElementById('success-state');
    const errorState = document.getElementById('error-state');
    const previewPane = document.getElementById('preview-pane');
    const htmlCodeOutput = document.getElementById('html-code-output');
    const copyBtn = document.getElementById('copy-btn');
    const copySuccessMsg = document.getElementById('copy-success-msg');

    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('data');

    if (!encoded) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        return;
    }

    try {
        const decoded = atob(encoded);
        const parsed = JSON.parse(decoded);
        const info = parsed.info || {};
        const buttons = parsed.buttons || [];
        const socials = parsed.socials || [];

        const phoneLink = (info.phone || '').replace(/[^\d]/g, '');
        const websiteLink = (info.website || '').startsWith('http') ? info.website : `https://${info.website}`;

        let buttonsHtml = '';
        if (buttons.length > 0) {
            buttonsHtml = '<tr><td colspan="2" style="padding-top: 12px;"><table border="0" cellpadding="0" cellspacing="0"><tr>';
            buttons.forEach(btn => {
                if (btn.label && btn.url) {
                    buttonsHtml += `<td style="padding-right: 8px;"><a href="${btn.url}" target="_blank" style="display:block; padding: 6px 12px; background-color: ${btn.color}; color: #ffffff; text-decoration: none; border-radius: 18px; font-weight: bold; font-size: 12px; text-align: center; font-family: Arial, sans-serif; white-space: nowrap;">${btn.label}</a></td>`;
                }
            });
            buttonsHtml += '</tr></table></td></tr>';
        }

        const socialIcons = {
            'Facebook': 'https://img.icons8.com/fluency/48/000000/facebook-new.png',
            'LinkedIn': 'https://img.icons8.com/fluency/48/000000/linkedin.png',
            'Instagram': 'https://img.icons8.com/fluency/48/000000/instagram-new.png',
            'X/Twitter': 'https://img.icons8.com/ios-filled/50/000000/twitterx.png',
            'TikTok': 'https://img.icons8.com/color/48/000000/tiktok--v1.png',
            'Threads': 'https://img.icons8.com/fluency/48/000000/threads.png',
            'Bluesky': 'https://seeklogo.com/images/B/bluesky-logo-1913610691-seeklogo.com.png'
        };

        let socialsHtml = '';
        if (socials.length > 0) {
            socialsHtml = '<tr><td colspan="2" style="padding-top: 10px;"><table border="0" cellpadding="0" cellspacing="0"><tr>';
            socials.forEach(social => {
                const icon = socialIcons[social.network] || '';
                if (social.url && icon) {
                    socialsHtml += `<td style="padding-right: 8px;"><a href="${social.url}" target="_blank"><img src="${icon}" width="24" height="24" alt="${social.network}" style="border:0; border-radius:6px; display:block;"></a></td>`;
                }
            });
            socialsHtml += '</tr></table></td></tr>';
        }

        const signatureHtml = `
        <table cellpadding="0" cellspacing="0" border="0" style="font-family: Arial, sans-serif; color: #333333; width: 100%;">
            <tr>
                <td style="padding-right: 16px; vertical-align: top; width: 90px; height: 90px; font-size: 0px; line-height: 0px;">
                    <img src="${info.image_url}" alt="Profile" style="display: block; width: 90px; height: 90px; object-fit: cover; ${info.image_style}">
                </td>
                <td style="vertical-align: top; padding-top: 5px;">
                    <div style="font-size: 18px; font-weight: bold; color: #195070; line-height: 1.2;">${info.name}</div>
                    <div style="font-size: 14px; color: #555555; line-height: 1.3; margin-top:2px;">${info.title} | ${info.company}</div>
                    <div style="margin-top: 8px; line-height: 1.4;">
                        ${info.phone ? `<div style="font-size: 13px;"><a href="tel:${phoneLink}" style="color: #195070; text-decoration: none;">${info.phone}</a></div>` : ''}
                        ${info.website ? `<div style="font-size: 13px;"><a href="${websiteLink}" target="_blank" style="color: #195070; text-decoration: none;">${info.website}</a></div>` : ''}
                    </div>
                </td>
            </tr>
            ${buttonsHtml}
            ${socialsHtml}
        </table>`;

        previewPane.innerHTML = signatureHtml;
        htmlCodeOutput.value = signatureHtml.trim();

        loadingState.style.display = 'none';
        successState.style.display = 'block';

        copyBtn.addEventListener('click', () => {
            htmlCodeOutput.select();
            document.execCommand('copy');

            copySuccessMsg.classList.remove('opacity-0');
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            copyBtn.classList.add('bg-green-600');

            setTimeout(() => {
                copySuccessMsg.classList.add('opacity-0');
                copyBtn.textContent = 'Copy Code to Clipboard';
                copyBtn.classList.remove('bg-green-600');
                copyBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }, 2500);
        });
    } catch (err) {
        console.error(err);
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
    }
});
</script>
